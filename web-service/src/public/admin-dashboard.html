<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="./assets/style.css">
  <script src="https://kit.fontawesome.com/e7df210b8c.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <style>
    .admin-badge {
      background-color: #ff5722;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      margin-left: 8px;
    }
    
    /* Notification Styles */
    .notification-bell {
      position: relative;
      display: inline-block;
    }
    
    .notification-btn {
      background: none;
      border: none;
      color: #333;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 5px 10px;
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #ff5722;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .notification-menu {
      position: absolute;
      top: 100%;
      right: 0;
      width: 320px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: none;
      z-index: 1000;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .notification-menu.active {
      display: block;
    }
    
    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }
    
    .notification-header h3 {
      margin: 0;
      font-size: 1rem;
    }
    
    .mark-all-read {
      background: none;
      border: none;
      color: #4a6cf7;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .notification-list {
      padding: 0;
    }
    
    .notification-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .notification-item:hover {
      background-color: #f9f9f9;
    }
    
    .notification-item.unread {
      background-color: #f0f7ff;
    }
    
    .notification-item .title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    
    .notification-item .message {
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 5px;
    }
    
    .notification-item .time {
      color: #999;
      font-size: 0.75rem;
      text-align: right;
    }
    
    .empty-notification {
      padding: 20px;
      text-align: center;
      color: #999;
      font-size: 0.9rem;
    }
    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .stat-card i {
      font-size: 2.5em;
      margin-bottom: 10px;
      color: #1976d2;
    }
    .stat-card h3 {
      margin: 0;
      font-size: 1.8em;
      color: #333;
    }
    .stat-card p {
      margin: 5px 0 0;
      color: #666;
    }
    .admin-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .admin-card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .admin-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(25, 118, 210, 0.05);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .admin-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .admin-card:hover::after {
      opacity: 1;
    }
    .admin-card h3 {
      margin-top: 0;
      color: #1976d2;
      display: flex;
      align-items: center;
    }
    .admin-card h3 i {
      margin-right: 10px;
    }
    .admin-card ul {
      padding-left: 20px;
    }
    .admin-card li {
      margin-bottom: 10px;
    }
    .admin-card a {
      display: inline-block;
      margin-top: 15px;
      background-color: #1976d2;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      text-decoration: none;
      transition: background-color 0.3s;
      position: relative;
      z-index: 2;
    }
    .admin-card a:hover {
      background-color: #1565c0;
    }
    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-card i {
      font-size: 2.5em;
      margin-bottom: 10px;
      color: #1976d2;
    }
    .stat-card h3 {
      margin: 0;
      font-size: 1.8em;
      color: #333;
    }
    .stat-card p {
      margin: 5px 0 0;
      color: #666;
    }
    .admin-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .admin-card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .admin-card h3 {
      margin-top: 0;
      color: #1976d2;
      display: flex;
      align-items: center;
    }
    .admin-card h3 i {
      margin-right: 10px;
    }
    .admin-card ul {
      padding-left: 20px;
    }
    .admin-card li {
      margin-bottom: 10px;
    }
    .admin-card a {
      display: inline-block;
      margin-top: 15px;
      background-color: #1976d2;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      text-decoration: none;
      transition: background-color 0.3s;
    }
    .admin-card a:hover {
      background-color: #1565c0;
    }
    .admin-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    .chart-container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .chart-container h3 {
      margin-top: 0;
      color: #1976d2;
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .chart-container h3 i {
      margin-right: 10px;
    }
  </style>
</head>
<body class="dashboard-bg" style="display: flex; flex-direction: column; min-height: 100vh;">
  <!-- Consistent Navbar for all pages -->
  <header class="navbar">
    <div class="logo">
      <a href="index.html"><img src="./assets/img/logo.png" alt="Logo" height="70px"></a>
    </div>
    <nav class="links">
      <li><a href="manage-complaints.html" class="nb">Manage Complaints</a></li>
      <li><a href="manage-users.html" class="nb">Manage Users</a></li>
      <li>
        <div class="notification-bell">
          <button class="notification-btn" id="notificationBtn">
            <i class="fa-solid fa-bell"></i>
            <span class="notification-badge" id="notificationBadge">0</span>
          </button>
          <div class="notification-menu" id="notificationMenu">
            <div class="notification-header">
              <h3>Notifications</h3>
              <button class="mark-all-read" id="markAllReadBtn">Mark all as read</button>
            </div>
            <div class="notification-list" id="notificationList">
              <div class="empty-notification">No new notifications</div>
            </div>
          </div>
        </div>
      </li>
      <li>
        <div class="profile-dropdown">
          <button class="profile-btn" id="profileBtn">
            <i class="fa-solid fa-user-shield"></i>
            <span id="profileName"></span>
            <span class="admin-badge">Admin</span>
            <i class="fa-solid fa-caret-down"></i>
          </button>
          <div class="profile-menu" id="profileMenu">
            <div class="profile-info">
              <i class="fa-solid fa-user-shield"></i>
              <div>
                <div><strong id="profileUsername">Username</strong> <span class="admin-badge">Admin</span></div>
                <div id="profileEmail" style="font-size:0.95em;color:#666;"></div>
              </div>
            </div>
            <div class="profile-details">
              <p><i class="fa-solid fa-id-card"></i> Student ID: <span id="profileEmailDetail"></span></p>
              <p><i class="fa-solid fa-calendar"></i> Joined: <span id="profileJoined"></span></p>
            </div>
            <button class="logout-btn" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
          </div>
        </div>
      </li>
    </nav>
  </header>
  <div class="dashboard-container" style="width: 100%; max-width: 100%; margin: 0; padding: 20px; box-sizing: border-box; flex: 1;">
    <h1><i class="fa-solid fa-user-shield"></i> Admin Dashboard</h1>
    <p>Manage complaints, users, and system settings from this central admin panel.</p>
    <button id="refreshDashboardBtn" class="refresh-btn" style="background-color: #1976d2; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;"><i class="fa-solid fa-sync-alt"></i> Refresh Dashboard</button>
    
    <div class="admin-stats">
      <div class="stat-card">
        <i class="fa-solid fa-ticket"></i>
        <h3 id="totalComplaints">0</h3>
        <p>Total Complaints</p>
      </div>
      <div class="stat-card">
        <i class="fa-solid fa-user-group"></i>
        <h3 id="totalUsers">0</h3>
        <p>Registered Users</p>
      </div>
      <div class="stat-card">
        <i class="fa-solid fa-clock-rotate-left"></i>
        <h3 id="pendingComplaints">0</h3>
        <p>Pending Complaints</p>
      </div>
      <div class="stat-card">
        <i class="fa-solid fa-check-circle"></i>
        <h3 id="resolvedComplaints">0</h3>
        <p>Resolved Complaints</p>
      </div>
    </div>
    
    <!-- Charts Section -->
    <div class="admin-charts">
      <div class="chart-container">
        <h3><i class="fa-solid fa-chart-pie"></i> Complaint Status Distribution</h3>
        <canvas id="statusChart"></canvas>
      </div>
      <div class="chart-container">
        <h3><i class="fa-solid fa-chart-column"></i> Complaint Priority Distribution</h3>
        <canvas id="priorityChart"></canvas>
      </div>
      <div class="chart-container">
        <h3><i class="fa-solid fa-face-smile"></i> Complaint Sentiment Analysis</h3>
        <canvas id="sentimentChart"></canvas>
      </div>
      <div class="chart-container">
        <h3><i class="fa-solid fa-chart-line"></i> Sentiment-Priority Correlation</h3>
        <canvas id="sentimentPriorityChart"></canvas>
      </div>
    </div>
    
    <div class="admin-actions">
      <div class="admin-card" onclick="window.location.href='manage-complaints.html'">
        <h3><i class="fa-solid fa-ticket-alt"></i> Complaint Management</h3>
        <ul>
          <li>View all submitted complaints</li>
          <li>Update complaint status</li>
          <li>Assign complaints to staff</li>
          <li>Generate complaint reports</li>
        </ul>
        <a href="manage-complaints.html"><i class="fa-solid fa-arrow-right"></i> Manage Complaints</a>
      </div>
      
      <div class="admin-card" onclick="window.location.href='manage-users.html'">
        <h3><i class="fa-solid fa-users-cog"></i> User Management</h3>
        <ul>
          <li>View all registered users</li>
          <li>Edit user information</li>
          <li>Manage user roles and permissions</li>
          <li>Deactivate problematic accounts</li>
        </ul>
        <a href="manage-users.html"><i class="fa-solid fa-arrow-right"></i> Manage Users</a>
      </div>
      
      <div class="admin-card" onclick="window.location.href='analytics.html'">
        <h3><i class="fa-solid fa-chart-line"></i> Analytics</h3>
        <ul>
          <li>View complaint statistics</li>
          <li>Track resolution times</li>
          <li>Monitor user activity</li>
          <li>Generate performance reports</li>
        </ul>
        <a href="analytics.html"><i class="fa-solid fa-arrow-right"></i> View Analytics</a>
      </div>
      
      <div class="admin-card" onclick="window.location.href='settings.html'">
        <h3><i class="fa-solid fa-cog"></i> System Settings</h3>
        <ul>
          <li>Configure notification settings</li>
          <li>Manage complaint categories</li>
          <li>Set up automated responses</li>
          <li>Backup and restore system data</li>
        </ul>
        <a href="settings.html"><i class="fa-solid fa-arrow-right"></i> System Settings</a>
      </div>
    </div>
  </div>
  
  <script>
  // Check if user is logged in and is an admin
  const userName = localStorage.getItem('userName');
  const userStudentId = localStorage.getItem('userStudentId');
  const userRole = localStorage.getItem('userRole');
  
  // Strict validation for admin access
  if (!userName || !userStudentId || !userRole) {
    window.location.href = "login.html";
    localStorage.clear(); // Clear any invalid session data
  } else if (userRole !== 'admin') {
    alert('Access Denied: Admin privileges required.');
    window.location.href = "dashboard.html";
    localStorage.removeItem('userRole'); // Clear potentially tampered role
  }
  
  // Set user info from localStorage
  const userJoined = localStorage.getItem('userJoined') || '2025-07-07';

  document.getElementById('profileName').innerText = userName;
  document.getElementById('profileUsername').innerText = userName;
  document.getElementById('profileEmail').innerText = userStudentId;
  document.getElementById('profileEmailDetail').innerText = userStudentId;
  document.getElementById('profileJoined').innerText = userJoined;

  // Dropdown toggle
  document.getElementById('profileBtn').onclick = function(e) {
    e.stopPropagation();
    document.getElementById('profileMenu').classList.toggle('show');
  };
  
  // Notification toggle
  document.getElementById('notificationBtn').onclick = function(e) {
    e.stopPropagation();
    document.getElementById('notificationMenu').classList.toggle('active');
    // If opening the menu, mark notifications as read
    if (document.getElementById('notificationMenu').classList.contains('active')) {
      markNotificationsAsRead();
    }
  };
  
  // Hide dropdowns when clicking outside
  window.onclick = function(event) {
    if (!event.target.closest('.profile-dropdown')) {
      document.getElementById('profileMenu').classList.remove('show');
    }
    if (!event.target.closest('.notification-bell')) {
      document.getElementById('notificationMenu').classList.remove('active');
    }
  }
  
  // Mark all notifications as read
  document.getElementById('markAllReadBtn').onclick = function(e) {
    e.stopPropagation();
    markNotificationsAsRead();
  };
  
  // Logout functionality
  document.getElementById('logoutBtn').onclick = function() {
    localStorage.removeItem('userName');
    localStorage.removeItem('userStudentId');
    localStorage.removeItem('userRole');
    localStorage.removeItem('userJoined');
    window.location.href = "index.html";
  };
  
  // Fetch real statistics from the API
  async function fetchDashboardStats() {
    try {
      const response = await fetch('http://localhost:3000/api/stats');
      if (!response.ok) {
        throw new Error('Failed to fetch statistics');
      }
      
      const data = await response.json();
      if (data.success) {
        document.getElementById('totalComplaints').innerText = data.stats.totalComplaints;
        document.getElementById('totalUsers').innerText = data.stats.totalUsers;
        document.getElementById('pendingComplaints').innerText = data.stats.pendingComplaints;
        document.getElementById('resolvedComplaints').innerText = data.stats.resolvedComplaints;
      }
    } catch (error) {
      console.error('Error fetching dashboard statistics:', error);
      // Keep placeholder data if API fails
      document.getElementById('totalComplaints').innerText = '0';
      document.getElementById('totalUsers').innerText = '0';
      document.getElementById('pendingComplaints').innerText = '0';
      document.getElementById('resolvedComplaints').innerText = '0';
    }
  }
  
  // Fetch complaints for charts
  async function fetchComplaintsForCharts() {
    try {
      const response = await fetch('http://localhost:3000/api/complaints?role=admin');
      if (!response.ok) {
        throw new Error('Failed to fetch complaints');
      }
      
      const data = await response.json();
      if (data.success && data.complaints) {
        createStatusChart(data.complaints);
        createPriorityChart(data.complaints);
        createSentimentChart(data.complaints);
        createSentimentPriorityChart(data.complaints);
      }
    } catch (error) {
      console.error('Error fetching complaints for charts:', error);
    }
  }
  
  // Create status distribution chart
  function createStatusChart(complaints) {
    // Count complaints by status
    const statusCounts = {
      'pending': 0,
      'processing': 0,
      'resolved': 0,
      'rejected': 0
    };
    
    complaints.forEach(complaint => {
      if (statusCounts.hasOwnProperty(complaint.status)) {
        statusCounts[complaint.status]++;
      }
    });
    
    // Create chart
    const ctx = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(statusCounts).map(status => status.charAt(0).toUpperCase() + status.slice(1)),
        datasets: [{
          data: Object.values(statusCounts),
          backgroundColor: [
            '#ffecb3', // pending - yellow
            '#e3f2fd', // processing - blue
            '#e8f5e9', // resolved - green
            '#ffebee'  // rejected - red
          ],
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          },
          title: {
            display: true,
            text: 'Complaint Status Distribution'
          }
        }
      }
    });
  }
  
  // Create priority distribution chart
  function createPriorityChart(complaints) {
    // Count complaints by priority
    const priorityCounts = {
      'low': 0,
      'medium': 0,
      'high': 0
    };
    
    complaints.forEach(complaint => {
      if (priorityCounts.hasOwnProperty(complaint.priority)) {
        priorityCounts[complaint.priority]++;
      }
    });
    
    // Create chart
    const ctx = document.getElementById('priorityChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(priorityCounts).map(priority => priority.charAt(0).toUpperCase() + priority.slice(1)),
        datasets: [{
          label: 'Number of Complaints',
          data: Object.values(priorityCounts),
          backgroundColor: [
            '#4fc3f7', // low - light blue
            '#ffa726', // medium - orange
            '#ef5350'  // high - red
          ],
          borderColor: [
            '#039be5',
            '#fb8c00',
            '#e53935'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          title: {
            display: true,
            text: 'Complaint Priority Distribution'
          }
        }
      }
    });
  }
  
  // Create sentiment analysis chart
  function createSentimentChart(complaints) {
    // Count complaints by sentiment
    const sentimentCounts = {
      'positive': 0,
      'neutral': 0,
      'negative': 0
    };
    
    complaints.forEach(complaint => {
      if (complaint.sentiment && sentimentCounts.hasOwnProperty(complaint.sentiment)) {
        sentimentCounts[complaint.sentiment]++;
      }
    });
    
    // Create chart
    const ctx = document.getElementById('sentimentChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(sentimentCounts).map(sentiment => sentiment.charAt(0).toUpperCase() + sentiment.slice(1)),
        datasets: [{
          data: Object.values(sentimentCounts),
          backgroundColor: [
            '#66bb6a', // positive - green
            '#ffee58', // neutral - yellow
            '#ef5350'  // negative - red
          ],
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          },
          title: {
            display: true,
            text: 'Complaint Sentiment Distribution'
          }
        }
      }
    });
  }
  
  // Create sentiment-priority correlation chart
  function createSentimentPriorityChart(complaints) {
    // Group complaints by sentiment and priority
    const correlationData = {
      'positive': { 'low': 0, 'medium': 0, 'high': 0 },
      'neutral': { 'low': 0, 'medium': 0, 'high': 0 },
      'negative': { 'low': 0, 'medium': 0, 'high': 0 }
    };
    
    complaints.forEach(complaint => {
      if (complaint.sentiment && complaint.priority && 
          correlationData.hasOwnProperty(complaint.sentiment) && 
          correlationData[complaint.sentiment].hasOwnProperty(complaint.priority)) {
        correlationData[complaint.sentiment][complaint.priority]++;
      }
    });
    
    // Prepare data for stacked bar chart
    const datasets = [
      {
        label: 'Low Priority',
        data: [correlationData.positive.low, correlationData.neutral.low, correlationData.negative.low],
        backgroundColor: '#4fc3f7', // light blue
        borderColor: '#039be5',
        borderWidth: 1
      },
      {
        label: 'Medium Priority',
        data: [correlationData.positive.medium, correlationData.neutral.medium, correlationData.negative.medium],
        backgroundColor: '#ffa726', // orange
        borderColor: '#fb8c00',
        borderWidth: 1
      },
      {
        label: 'High Priority',
        data: [correlationData.positive.high, correlationData.neutral.high, correlationData.negative.high],
        backgroundColor: '#ef5350', // red
        borderColor: '#e53935',
        borderWidth: 1
      }
    ];
    
    // Create chart
    const ctx = document.getElementById('sentimentPriorityChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Positive', 'Neutral', 'Negative'],
        datasets: datasets
      },
      options: {
        responsive: true,
        scales: {
          x: {
            stacked: true,
          },
          y: {
            stacked: true,
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        },
        plugins: {
          legend: {
            position: 'bottom'
          },
          title: {
            display: true,
            text: 'Sentiment-Priority Correlation'
          },
          tooltip: {
            callbacks: {
              footer: (tooltipItems) => {
                return 'ML-based classification';
              }
            }
          }
        }
      }
    });
  }
  
  // Notification System
  let notifications = [];
  let lastCheckedTimestamp = new Date().toISOString();
  let notificationSound;
  let websocket;
  
  // Initialize notifications from localStorage
  function initializeNotifications() {
    const savedNotifications = localStorage.getItem('adminNotifications');
    if (savedNotifications) {
      notifications = JSON.parse(savedNotifications);
      updateNotificationBadge();
      renderNotifications();
    }
    
    // Initialize notification sound
    notificationSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-alert-notification-256.mp3');
    
    // Initialize WebSocket connection if supported
    initializeWebSocket();
  }
  
  // Initialize WebSocket for real-time notifications
  function initializeWebSocket() {
    if ('WebSocket' in window) {
      // Connect to WebSocket server (if available)
      try {
        websocket = new WebSocket('ws://localhost:3001');
        
        websocket.onopen = function() {
          console.log('WebSocket connection established');
          // Authenticate the admin connection
          const userData = JSON.parse(localStorage.getItem('user'));
          if (userData && userData.role === 'admin') {
            websocket.send(JSON.stringify({
              type: 'auth',
              role: 'admin',
              userId: userData.studentId
            }));
          }
        };
        
        websocket.onmessage = function(event) {
          const data = JSON.parse(event.data);
          
          if (data.type === 'new_complaint') {
            // Handle new complaint notification
            handleRealTimeComplaint(data.complaint);
          }
        };
        
        websocket.onerror = function(error) {
          console.error('WebSocket error:', error);
          // Fall back to polling if WebSocket fails
        };
        
        websocket.onclose = function() {
          console.log('WebSocket connection closed');
          // Attempt to reconnect after a delay
          setTimeout(initializeWebSocket, 5000);
        };
      } catch (error) {
        console.error('Failed to establish WebSocket connection:', error);
        // Continue with polling as fallback
      }
    }
  }
  
  // Handle real-time complaint from WebSocket
  function handleRealTimeComplaint(complaint) {
    // Update last checked timestamp
    lastCheckedTimestamp = new Date().toISOString();
    
    // Create notification for the new complaint
    const notificationType = getNotificationTypeByPriority(complaint.priority);
    
    addNotification({
      id: `complaint-${complaint.id}`,
      title: `New ${complaint.priority.toUpperCase()} Priority Complaint`,
      message: `${truncateText(complaint.description, 50)}`,
      time: new Date().toISOString(),
      read: false,
      link: `manage-complaints.html?id=${complaint.id}`,
      priority: complaint.priority,
      type: notificationType
    });
    
    // Play sound for high priority complaints
    if (complaint.priority === 'high') {
      playNotificationSound();
    }
    
    // Show toast notification
    showToastNotification(`New ${complaint.priority} priority complaint received`, complaint.priority);
    
    // Refresh dashboard stats and charts
    fetchDashboardStats();
    fetchComplaintsForCharts();
  }
  
  // Save notifications to localStorage
  function saveNotifications() {
    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
  }
  
  // Helper function to truncate text
  function truncateText(text, maxLength) {
    if (!text) return '';
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
  }
  
  // Get notification type based on priority
  function getNotificationTypeByPriority(priority) {
    switch(priority) {
      case 'high': return 'urgent';
      case 'medium': return 'standard';
      case 'low': return 'info';
      default: return 'standard';
    }
  }
  
  // Play notification sound
  function playNotificationSound() {
    try {
      // Reset the sound to the beginning
      notificationSound.currentTime = 0;
      notificationSound.play();
    } catch (error) {
      console.error('Error playing notification sound:', error);
    }
  }
  
  // Show toast notification with priority-based styling
  function showToastNotification(message, priority) {
    let backgroundColor = '#1976d2'; // Default blue
    
    if (priority === 'high') {
      backgroundColor = '#d32f2f'; // Red for high priority
    } else if (priority === 'medium') {
      backgroundColor = '#ff9800'; // Orange for medium priority
    }
    
    Toastify({
      text: message,
      duration: 5000,
      close: true,
      gravity: "top",
      position: "right",
      backgroundColor: backgroundColor,
      stopOnFocus: true,
      onClick: function() {
        document.getElementById('notificationBtn').click();
      }
    }).showToast();
  }
  
  // Check for new complaints (polling fallback)
  async function checkForNewComplaints() {
    // Skip if WebSocket is connected
    if (websocket && websocket.readyState === WebSocket.OPEN) {
      return;
    }
    
    try {
      const response = await fetch(`http://localhost:3000/api/complaints?role=admin&since=${encodeURIComponent(lastCheckedTimestamp)}`);
      if (!response.ok) {
        throw new Error('Failed to fetch new complaints');
      }
      
      const data = await response.json();
      if (data.success && data.complaints && data.complaints.length > 0) {
        // Update last checked timestamp
        lastCheckedTimestamp = new Date().toISOString();
        
        // Create notifications for new complaints
        data.complaints.forEach(complaint => {
          const notificationType = getNotificationTypeByPriority(complaint.priority);
          
          addNotification({
            id: `complaint-${complaint.id}`,
            title: `New ${complaint.priority.toUpperCase()} Priority Complaint`,
            message: `${truncateText(complaint.description, 50)}`,
            time: new Date().toISOString(),
            read: false,
            link: `manage-complaints.html?id=${complaint.id}`,
            priority: complaint.priority,
            type: notificationType
          });
          
          // Play sound for high priority complaints
          if (complaint.priority === 'high') {
            playNotificationSound();
          }
        });
        
        // Show toast notification
        showToastNotification(`${data.complaints.length} new complaint(s) received`, 
                             data.complaints.length === 1 ? data.complaints[0].priority : 'standard');
        
        // Refresh dashboard stats
        fetchDashboardStats();
        fetchComplaintsForCharts();
      }
    } catch (error) {
      console.error('Error checking for new complaints:', error);
    }
  }
  
  // Add a new notification
  function addNotification(notification) {
    // Add to beginning of array
    notifications.unshift(notification);
    
    // Limit to 50 notifications
    if (notifications.length > 50) {
      notifications = notifications.slice(0, 50);
    }
    
    // Save to localStorage
    saveNotifications();
    
    // Update UI
    updateNotificationBadge();
    renderNotifications();
  }
  
  // Mark all notifications as read
  function markNotificationsAsRead() {
    notifications.forEach(notification => {
      notification.read = true;
    });
    
    saveNotifications();
    updateNotificationBadge();
    renderNotifications();
  }
  
  // Update notification badge count
  function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notificationBadge');
    
    badge.innerText = unreadCount;
    badge.style.display = unreadCount > 0 ? 'flex' : 'none';
  }
  
  // Render notifications in the dropdown
  function renderNotifications() {
    const notificationList = document.getElementById('notificationList');
    
    // Clear current notifications
    notificationList.innerHTML = '';
    
    if (notifications.length === 0) {
      notificationList.innerHTML = '<div class="empty-notification">No new notifications</div>';
      return;
    }
    
    // Add mark all as read button
    const markAllReadBtn = document.createElement('div');
    markAllReadBtn.className = 'mark-all-read';
    markAllReadBtn.innerHTML = '<i class="fas fa-check-double"></i> Mark all as read';
    markAllReadBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      markNotificationsAsRead();
    });
    notificationList.appendChild(markAllReadBtn);
    
    // Group notifications by date
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const groupedNotifications = {
      today: [],
      yesterday: [],
      older: []
    };
    
    notifications.forEach(notification => {
      const notificationDate = new Date(notification.time);
      notificationDate.setHours(0, 0, 0, 0);
      
      if (notificationDate.getTime() === today.getTime()) {
        groupedNotifications.today.push(notification);
      } else if (notificationDate.getTime() === yesterday.getTime()) {
        groupedNotifications.yesterday.push(notification);
      } else {
        groupedNotifications.older.push(notification);
      }
    });
    
    // Render grouped notifications
    if (groupedNotifications.today.length > 0) {
      renderNotificationGroup('Today', groupedNotifications.today, notificationList);
    }
    
    if (groupedNotifications.yesterday.length > 0) {
      renderNotificationGroup('Yesterday', groupedNotifications.yesterday, notificationList);
    }
    
    if (groupedNotifications.older.length > 0) {
      renderNotificationGroup('Older', groupedNotifications.older, notificationList);
    }
  }
  
  // Render a group of notifications
  function renderNotificationGroup(title, notificationGroup, container) {
    // Add group header
    const groupHeader = document.createElement('div');
    groupHeader.className = 'notification-group-header';
    groupHeader.textContent = title;
    container.appendChild(groupHeader);
    
    // Add notifications to the group
    notificationGroup.forEach(notification => {
      const notificationItem = document.createElement('div');
      notificationItem.className = `notification-item${notification.read ? '' : ' unread'}`;
      
      // Add priority-based styling
      if (notification.priority) {
        notificationItem.classList.add(`priority-${notification.priority}`);
      }
      
      // Add type-based styling
      if (notification.type) {
        notificationItem.classList.add(`type-${notification.type}`);
      }
      
      notificationItem.dataset.id = notification.id;
      
      const formattedTime = new Date(notification.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      notificationItem.innerHTML = `
        <div class="title">${notification.title}</div>
        <div class="message">${notification.message}</div>
        <div class="time">${formattedTime}</div>
      `;
      
      notificationItem.addEventListener('click', () => {
        // Mark as read
        const notificationIndex = notifications.findIndex(n => n.id === notification.id);
        if (notificationIndex !== -1) {
          notifications[notificationIndex].read = true;
          saveNotifications();
          updateNotificationBadge();
          renderNotifications(); // Re-render to update the unread styling
        }
        
        // Navigate to link if provided
        if (notification.link) {
          window.location.href = notification.link;
        }
      });
      
      container.appendChild(notificationItem);
    });
  }
  
  // Add CSS for enhanced notifications
  const notificationStyles = document.createElement('style');
  notificationStyles.textContent = `
    .notification-group-header {
      padding: 8px 12px;
      background-color: #f5f5f5;
      font-weight: bold;
      font-size: 0.9rem;
      color: #555;
      border-bottom: 1px solid #ddd;
    }
    
    .mark-all-read {
      padding: 8px 12px;
      text-align: center;
      color: #1976d2;
      cursor: pointer;
      font-size: 0.9rem;
      border-bottom: 1px solid #ddd;
    }
    
    .mark-all-read:hover {
      background-color: #f0f7ff;
    }
    
    .notification-item {
      position: relative;
      border-left: 3px solid transparent;
    }
    
    .notification-item.unread {
      border-left-color: #1976d2;
    }
    
    .notification-item.priority-high {
      border-left-color: #d32f2f;
    }
    
    .notification-item.priority-medium {
      border-left-color: #ff9800;
    }
    
    .notification-item.type-urgent .title {
      color: #d32f2f;
    }
    
    .notification-item.type-standard .title {
      color: #1976d2;
    }
    
    .notification-item.type-info .title {
      color: #388e3c;
    }
  `;
  document.head.appendChild(notificationStyles);
  
  // Call the functions to load data
  document.addEventListener('DOMContentLoaded', function() {
    fetchDashboardStats();
    fetchComplaintsForCharts();
    initializeNotifications();
    
    // Set up polling for new complaints (check every 15 seconds)
    // This serves as a fallback if WebSocket is not available
    setInterval(checkForNewComplaints, 15000);
    
    // Add refresh button functionality
    document.getElementById('refreshDashboardBtn').addEventListener('click', function() {
      // Show loading indicator
      this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Refreshing...';
      this.disabled = true;
      
      // Refresh all data
      Promise.all([
        fetchDashboardStats(),
        fetchComplaintsForCharts()
      ])
      .then(() => {
        // Restore button state
        this.innerHTML = '<i class="fa-solid fa-sync-alt"></i> Refresh Dashboard';
        this.disabled = false;
        
        // Show success message
        showToastNotification('Dashboard refreshed successfully', 'medium');
      })
      .catch(error => {
        console.error('Error refreshing dashboard:', error);
        // Restore button state
        this.innerHTML = '<i class="fa-solid fa-sync-alt"></i> Refresh Dashboard';
        this.disabled = false;
        
        // Show error message
        showToastNotification('Failed to refresh dashboard', 'high');
      });
    });
  });
</script>
</body>
</html>